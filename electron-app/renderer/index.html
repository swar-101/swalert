<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Swalert</title>

    <!-- Load fonts dynamically for Electron -->
    <script>
        (function () {
            const base = (location.href.match(/^file:.*\/(?:renderer\/)?/) || [location.href.replace(/\/[^/]+$/, '/')])[0];
            const pixelFont = base + 'assets/fonts/PixelatedElegance-Regular.ttf';
            const ubuntuFont = base + 'assets/fonts/UbuntuMono-Regular.ttf';
            const s = document.createElement('style');
            s.textContent = `
        @font-face {
          font-family: 'Pixelated Elegance';
          src: url('${pixelFont}') format('truetype');
          font-display: swap;
        }
        @font-face {
          font-family: 'Ubuntu Mono';
          src: url('${ubuntuFont}') format('truetype');
          font-display: swap;
        }
      `;
            document.head.appendChild(s);
        })();
    </script>

    <link rel="stylesheet" href="./styles/theme.css"/>
    <link rel="stylesheet" href="./styles/layout.css"/>
    <link rel="stylesheet" href="./styles/components.css"/>
</head>

<body>
<main class="app">
    <!-- Fixed Glassy Header -->
    <header class="chat-header">
<!--        <h2>Swalert.</h2>-->
        <img src="./assets/icons/swalert-logo.svg" alt="Swalert Logo" class="app-logo"/>
        <button id="refreshBtn" class="icon-refresh" title="Refresh (Ctrl + R)">
            <img src="./assets/icons/sync.svg" alt="refresh"/>
        </button>
    </header>

    <!-- Scrollable Feed -->
    <section class="chat-feed">

        <div class="alert-group content-width">
            <div class="alert-card">
                <p>https://leetcode.com/problems/find-x-sum-of-all-k-long-subarrays-ii/</p>
            </div>
            <div class="meta">10th Oct 2025, 9:35 pm via ðŸ“± over Wi-Fi</div>
        </div>

        <div class="alert-group content-width">
            <div class="alert-card">
                <p>
                    WITH product_with_earliest_year_sale AS (<br />
                    SELECT product_id, MIN(year)<br />
                    GROUP BY product_id<br />
                    HAVING year = MIN(year)<br />);
                </p>
            </div>
            <div class="meta">tonight, 11:35 am via ðŸ’» over Cloud</div>
        </div>

        <div class="alert-group content-width">
            <div class="alert-card">
                <p>
                    The quick brown fox jumps over the lazy dog.<br />
                    This is the link to<br />
                    curl -i
                    <a href="#">https://swalert-relay-production.swalert.workers.dev</a>
                </p>
            </div>
            <div class="meta">just now via ðŸ“± over Wi-Fi</div>
        </div>

    </section>

    <!-- Floating Chat Bar -->
    <div class="chatbar content-width">
        <button id="attachBtn" class="icon-btn" title="Attach">
            <img src="./assets/icons/attach.svg" alt="attach"/>
        </button>

        <textarea id="msgInput" placeholder="Paste or Drop almost anything!"></textarea>

        <button id="sendBtn" class="icon-btn" title="Send">
            <img src="./assets/icons/send.svg" alt="send"/>
        </button>
    </div>
</main>

<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
<script>
    const refreshBtn = document.getElementById('refreshBtn');
    const sendBtn = document.getElementById('sendBtn');
    const msgInput = document.getElementById('msgInput');
    const chatFeed = document.querySelector('.chat-feed');

    const STORAGE_KEY = 'swalert_messages';

    // === Utility: Detect and convert URLs ===
    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            const safeUrl = url.replace(/"/g, '&quot;');
            return `<a href="${safeUrl}" target="_blank">${url}</a>`;
        });
    }

    // === Utility: Create a meta icon + label based on source ===
    function getSourceIcon(source) {
        const icons = {
            local: { icon: 'computer', label: 'Local' },
            relay: { icon: 'cloud', label: 'Relay' },
            mobile: { icon: 'smartphone', label: 'Mobile' },
            web: { icon: 'language', label: 'Web' },
        };
        return icons[source.toLowerCase()] || icons.local;
    }

    // === Create alert-group DOM ===
    function createAlertGroup(message, timestamp = Date.now(), source = 'local') {
        const alertGroup = document.createElement('div');
        alertGroup.className = 'alert-group content-width';

        const alertCard = document.createElement('div');
        alertCard.className = 'alert-card';
        alertCard.innerHTML = `<p>${linkify(message).replace(/\n/g, '<br>')}</p>`;

        const meta = document.createElement('div');
        meta.className = 'meta';

        const timeStr = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        const { icon, label } = getSourceIcon(source);

        meta.innerHTML = `
            <span class="material-symbols-rounded" style="font-size: 1rem; vertical-align: middle; opacity: 0.7;">${icon}</span>
            <span style="opacity: 0.8;">${label}</span> Â· ${timeStr}
        `;

        alertGroup.appendChild(alertCard);
        alertGroup.appendChild(meta);

        return alertGroup;
    }

    // === Add alert to feed + save to localStorage ===
    function addAlertToFeed(message, timestamp = Date.now(), source = 'local', save = true) {
        const alertGroup = createAlertGroup(message, timestamp, source);

        chatFeed.appendChild(alertGroup);

        alertGroup.style.opacity = '0';
        alertGroup.style.transform = 'translateY(8px)';
        setTimeout(() => {
            alertGroup.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            alertGroup.style.opacity = '1';
            alertGroup.style.transform = 'translateY(0)';
        }, 10);

        chatFeed.scrollTo({ top: chatFeed.scrollHeight, behavior: 'smooth' });

        if (save) {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            messages.push({ message, timestamp, source });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
        }
    }

    // === Load saved messages on startup ===
    function loadSavedMessages() {
        const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        for (const msg of messages) {
            addAlertToFeed(msg.message, msg.timestamp, msg.source, false);
        }
    }

    // === Event bindings ===
    refreshBtn.addEventListener('click', () => {
        window.swalertAPI.refresh();
    });

    sendBtn.addEventListener('click', () => {
        const message = msgInput.value.trim();
        if (message.length > 0) {
            addAlertToFeed(message); // show instantly
            window.swalertAPI.sendMessage(message); // send async
            msgInput.value = '';
            msgInput.style.height = 'auto';
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key.toLowerCase() === 'r') {
            e.preventDefault();
            window.swalertAPI.refresh();
        }
    });

    msgInput.addEventListener('input', () => {
        msgInput.style.height = 'auto';
        msgInput.style.height = msgInput.scrollHeight + 'px';
    });

    window.addEventListener('DOMContentLoaded', loadSavedMessages);
</script>
</body>
</html>